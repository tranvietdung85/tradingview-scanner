name: Smoke Test

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: 'Symbol (e.g., BTCUSDT)'
        default: 'BTCUSDT'
        required: false
      interval:
        description: 'Interval (e.g., 1h)'
        default: '1h'
        required: false
      limit:
        description: 'Candles to fetch'
        default: '60'
        required: false
      toTelegram:
        description: 'Send to Telegram (true/false)'
        default: 'false'
        required: false
      includeABW:
        description: 'Include AB_W in report (true/false)'
        default: 'false'
        required: false

jobs:
  smoke:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Export Telegram secrets (if any)
        if: ${{ github.event.inputs.toTelegram == 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}" >> $GITHUB_ENV
          echo "TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}" >> $GITHUB_ENV

      - name: Run smoke test
        run: |
          ARGS="--symbol ${{ github.event.inputs.symbol }} --interval ${{ github.event.inputs.interval }} --limit ${{ github.event.inputs.limit }}"
          if [ "${{ github.event.inputs.includeABW }}" = "true" ]; then ARGS="$ARGS --include-abw"; fi
          if [ "${{ github.event.inputs.toTelegram }}" = "true" ]; then ARGS="$ARGS --to-telegram"; fi
          echo "python -m src.smoke_test $ARGS"
          python -m src.smoke_test $ARGS
